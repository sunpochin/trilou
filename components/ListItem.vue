<!--
  ğŸ“‹ ListItem çµ„ä»¶ - çœ‹æ¿åˆ—è¡¨çµ„ä»¶ (Trello Clone æ ¸å¿ƒçµ„ä»¶ä¹‹ä¸€)
  
  ğŸ¯ çµ„ä»¶ä¸»è¦åŠŸèƒ½ï¼š
  âœ… æ¸²æŸ“å–®ä¸€çœ‹æ¿åˆ—è¡¨åŠå…¶æ‰€æœ‰å¡ç‰‡
  âœ… æ”¯æ´åˆ—è¡¨æ¨™é¡Œçš„å³æ™‚ç·¨è¼¯åŠŸèƒ½ (é»æ“Šæ¨™é¡Œå¯ç·¨è¼¯ï¼ŒæŒ‰ Enter å„²å­˜ï¼ŒæŒ‰ Esc å–æ¶ˆ)
  âœ… ç®¡ç†å¡ç‰‡çš„æ‹–æ‹½æ’åºåŠŸèƒ½ (åŒåˆ—è¡¨å…§ç§»å‹• + è·¨åˆ—è¡¨ç§»å‹•)
  âœ… æä¾›åˆ—è¡¨æ“ä½œé¸å–® (æ–°å¢å¡ç‰‡ã€åˆªé™¤åˆ—è¡¨)
  âœ… è™•ç†å¡ç‰‡çš„æ–°å¢å’Œé–‹å•Ÿç·¨è¼¯åŠŸèƒ½
  âœ… æ•´åˆäº‹ä»¶é€šè¨Šç³»çµ±ï¼Œå°‡æ“ä½œå‚³éçµ¦çˆ¶çµ„ä»¶
  
  ğŸ”§ ä½¿ç”¨çš„æŠ€è¡“æ£§ï¼š
  - Vue 3 Composition API
  - VueDraggableNext (æ‹–æ‹½åŠŸèƒ½)
  - è‡ªè¨‚ useListActions composable (æ¥­å‹™é‚è¼¯æŠ½è±¡å±¤)
  - TypeScript å‹åˆ¥å®‰å…¨
  - Tailwind CSS æ¨£å¼
  
  ğŸ“¦ Props åƒæ•¸ï¼š
  - list: ListUI - åˆ—è¡¨è³‡æ–™ç‰©ä»¶ï¼ŒåŒ…å« idã€titleã€positionã€cards ç­‰æ¬„ä½
  
  ğŸš€ Emit äº‹ä»¶ï¼š
  - card-move: ç•¶å¡ç‰‡è¢«æ‹–æ‹½ç§»å‹•æ™‚è§¸ç™¼ï¼Œå‚³éæ‹–æ‹½äº‹ä»¶è³‡æ–™çµ¦çˆ¶çµ„ä»¶è™•ç†
  - open-card-modal: ç•¶é»æ“Šå¡ç‰‡è¦é–‹å•Ÿç·¨è¼¯æ¨¡æ…‹æ¡†æ™‚è§¸ç™¼ï¼Œå‚³éå¡ç‰‡è³‡æ–™çµ¦çˆ¶çµ„ä»¶
  
  ğŸ—ï¸ å­çµ„ä»¶çµæ§‹ï¼š
  - Card.vue: æ¸²æŸ“å–®ä¸€å¡ç‰‡ï¼Œè™•ç†å¡ç‰‡é¡¯ç¤ºå’Œé»æ“Šäº‹ä»¶
  - ListMenu.vue: æ¸²æŸ“ä¸‰é»é¸å–®ï¼Œæä¾›åˆ—è¡¨æ“ä½œåŠŸèƒ½ (æ–°å¢å¡ç‰‡ã€åˆªé™¤åˆ—è¡¨)
  
  ğŸ’¡ æ ¸å¿ƒäº¤äº’é‚è¼¯ï¼š
  1. åˆ—è¡¨æ¨™é¡Œç·¨è¼¯ï¼šé»æ“Šæ¨™é¡Œ â†’ è®Šæˆè¼¸å…¥æ¡† â†’ Enter å„²å­˜ / Esc å–æ¶ˆ / å¤±ç„¦å„²å­˜
  2. å¡ç‰‡æ‹–æ‹½ç§»å‹•ï¼šä½¿ç”¨ VueDraggableNextï¼Œæ”¯æ´åŒåˆ—è¡¨æ’åºå’Œè·¨åˆ—è¡¨ç§»å‹•
  3. æ–°å¢å¡ç‰‡ï¼šé»æ“Šåº•éƒ¨æŒ‰éˆ•æˆ–é¸å–®é …ç›® â†’ å‘¼å« useListActions.addCard()
  4. åˆªé™¤åˆ—è¡¨ï¼šé€šéé¸å–® â†’ å‘¼å« useListActions.deleteList()
  5. é–‹å•Ÿå¡ç‰‡ç·¨è¼¯ï¼šé»æ“Šå¡ç‰‡ â†’ emit äº‹ä»¶çµ¦çˆ¶çµ„ä»¶é–‹å•Ÿæ¨¡æ…‹æ¡†
  
  ğŸ¯ SOLID åŸå‰‡è¨­è¨ˆèªªæ˜ï¼š
  
  âœ… S (Single Responsibility) - å–®ä¸€è·è²¬åŸå‰‡
     åªè² è²¬ã€Œå–®å€‹åˆ—è¡¨ã€çš„æ¸²æŸ“å’ŒåŸºæœ¬äº’å‹•ï¼Œä¸è™•ç†æ•´é«”çœ‹æ¿é‚è¼¯
     æ¨™é¡Œç·¨è¼¯ã€å¡ç‰‡ç®¡ç†ã€é¸å–®æ“ä½œå„è‡ªç¨ç«‹ï¼Œè·è²¬æ¸…æ™°åˆ†é›¢
     
  âœ… O (Open/Closed) - é–‹æ”¾å°é–‰åŸå‰‡
     è¦æ–°å¢åˆ—è¡¨åŠŸèƒ½æ™‚ï¼Œé€é emit äº‹ä»¶å’Œ useListActions æ“´å±•
     ä¸éœ€è¦ä¿®æ”¹æ­¤çµ„ä»¶çš„æ ¸å¿ƒé‚è¼¯ï¼Œç¬¦åˆå°æ“´å±•é–‹æ”¾ã€å°ä¿®æ”¹å°é–‰
     
  âœ… L (Liskov Substitution) - é‡Œæ°æ›¿æ›åŸå‰‡
     çµ„ä»¶æ¥å— ListUI å‹åˆ¥ï¼Œä»»ä½•ç¬¦åˆæ­¤ä»‹é¢çš„åˆ—è¡¨ç‰©ä»¶éƒ½å¯ä»¥æ­£å¸¸é‹ä½œ
     ä¸æœƒå› ç‚ºåˆ—è¡¨è³‡æ–™çš„ç´°å¾®å·®ç•°è€Œå°è‡´çµ„ä»¶åŠŸèƒ½ç•°å¸¸
     
  âœ… I (Interface Segregation) - ä»‹é¢éš”é›¢åŸå‰‡
     åªä¾è³´æ‰€éœ€çš„ props å’Œ emit äº‹ä»¶ï¼Œä¸å¼·è¿«ä½¿ç”¨è€…å¯¦ä½œä¸éœ€è¦çš„ä»‹é¢
     useListActions åªæš´éœ²æ­¤çµ„ä»¶å¯¦éš›éœ€è¦çš„æ–¹æ³•
     
  âœ… D (Dependency Inversion) - ä¾è³´åè½‰åŸå‰‡  
     ä¸ç›´æ¥ä¾è³´ boardStoreï¼Œè€Œæ˜¯é€é useListActions æŠ½è±¡å±¤
     çµ„ä»¶ä¾è³´æŠ½è±¡ä»‹é¢ï¼Œä¸ä¾è³´å…·é«”å¯¦ä½œï¼Œæå‡å¯æ¸¬è©¦æ€§å’Œç¶­è­·æ€§
     
  ğŸ“ æ“´å±•æ–¹å¼ï¼š
     - æ–°å¢åˆ—è¡¨æ“ä½œï¼šåœ¨ useListActions åŠ å‡½æ•¸ï¼Œæ­¤çµ„ä»¶è‡ªå‹•å¯ç”¨
     - æ–°å¢ UI å…ƒç´ ï¼šåœ¨ ListMenu çµ„ä»¶åŠ æŒ‰éˆ•ï¼Œæ­¤çµ„ä»¶æ¥æ”¶ emit äº‹ä»¶
     - æ–°å¢å¡ç‰‡åŠŸèƒ½ï¼šä¿®æ”¹ Card çµ„ä»¶ï¼Œæ­¤çµ„ä»¶è‡ªå‹•ç¹¼æ‰¿æ–°åŠŸèƒ½
     - ä¿®æ”¹æ‹–æ‹½è¡Œç‚ºï¼šèª¿æ•´ draggable çµ„ä»¶çš„è¨­å®šï¼Œä¸å½±éŸ¿å…¶ä»–é‚è¼¯
  
  ğŸ§ª æ¸¬è©¦è¦†è“‹ï¼š
     çµ„ä»¶å·²æœ‰å®Œæ•´çš„å–®å…ƒæ¸¬è©¦è¦†è“‹ï¼ŒåŒ…å«æ‹–æ‹½åŠŸèƒ½ã€äº‹ä»¶è™•ç†ã€ç·¨è¼¯åŠŸèƒ½ç­‰
     æ¸¬è©¦æ–‡ä»¶ï¼štests/unit/components/CardDragDrop.test.ts (åŒ…å« ListItem æ¸¬è©¦)
  
  ğŸ“Š æ•ˆèƒ½è€ƒé‡ï¼š
     - ä½¿ç”¨ Vue 3 éŸ¿æ‡‰å¼ç³»çµ±ï¼Œåªåœ¨å¿…è¦æ™‚é‡æ–°æ¸²æŸ“
     - æ‹–æ‹½åŠŸèƒ½ä½¿ç”¨è™›æ“¬ DOM æœ€ä½³åŒ–ï¼Œæ”¯æ´å¤§é‡å¡ç‰‡çš„é †æš¢ç§»å‹•
     - äº‹ä»¶è™•ç†ä½¿ç”¨ event.stopPropagation() é¿å…ä¸å¿…è¦çš„äº‹ä»¶å†’æ³¡
  
  ğŸ”„ ç‹€æ…‹ç®¡ç†ï¼š
     - æœ¬åœ°ç‹€æ…‹ï¼šåˆ—è¡¨æ¨™é¡Œç·¨è¼¯ç‹€æ…‹ (isEditingTitle, editingTitle)
     - å…¨åŸŸç‹€æ…‹ï¼šé€é useListActions èˆ‡ boardStore äº’å‹•
     - éŸ¿æ‡‰å¼æ›´æ–°ï¼šç•¶ boardStore è³‡æ–™è®Šæ›´æ™‚ï¼Œçµ„ä»¶è‡ªå‹•é‡æ–°æ¸²æŸ“
-->

<template>
  <!-- å–®å€‹åˆ—è¡¨å®¹å™¨ -->
  <div class="bg-gray-200 rounded w-80 p-2 flex-shrink-0 flex flex-col" :data-list-id="list.id">
    <!-- åˆ—è¡¨æ¨™é¡Œå€åŸŸ -->
    <div class="cursor-pointer flex justify-between items-center p-2 mb-2 relative">
      <!-- éç·¨è¼¯ç‹€æ…‹ï¼šé¡¯ç¤ºæ¨™é¡Œ -->
      <h2 
        v-if="!isEditingTitle" 
        class="w-full text-base font-bold select-none cursor-pointer hover:bg-gray-100 px-2 py-1 rounded"
        @click="startEditTitle"
      >
        {{ list.title }}
      </h2>
      
      <!-- ç·¨è¼¯ç‹€æ…‹ï¼šé¡¯ç¤ºè¼¸å…¥æ¡† -->
      <input
        v-else
        ref="titleInput"
        v-model="editingTitle"
        class="w-full text-base font-bold bg-white border-2 border-blue-400 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-300 transition-all"
        @keydown.enter="saveTitle"
        @blur="saveTitle"
        @keydown.esc="cancelEdit"
      />
      
      <!-- åˆ—è¡¨é¸å–®çµ„ä»¶ -->
      <ListMenu 
        :list-id="list.id"
        @add-card="handleAddCard"
        @delete-list="handleDeleteList"
      />
    </div>
    
    <!-- å¯æ‹–æ‹‰çš„å¡ç‰‡å®¹å™¨ -->
    <div class="flex-1 overflow-y-auto">
      <draggable
        class="min-h-5"
        :list="list.cards"
        group="cards"
        tag="div"
        :disabled="false"
        :force-fallback="props.isMobile"
        :delay="props.isMobile ? 750 : 0"
        :touch-start-threshold="props.isMobile ? 10 : 0"
        :animation="200"
        easing="cubic-bezier(0.25, 0.46, 0.45, 0.94)"
        @change="$emit('card-move', $event)"
      >
        <div v-for="card in list.cards" :key="card.id">
          <Card 
            :card="card" 
            :dragging="dragging"
            :is-mobile="props.isMobile"
            @open-modal="$emit('open-card-modal', card)"
            @delete="$emit('card-delete', card)"
            @update-title="(cardId, newTitle) => $emit('card-update-title', cardId, newTitle)"
          />
        </div>
      </draggable>
    </div>
    
    <!-- æ–°å¢å¡ç‰‡å€åŸŸ -->
    <div class="mt-2">
      <!-- é¡¯ç¤ºæŒ‰éˆ•æ¨¡å¼ -->
      <button 
        v-if="!isAddingCard"
        class="w-full p-3 bg-transparent border-2 border-dashed border-gray-300 rounded text-gray-600 cursor-pointer text-sm transition-all duration-200 hover:bg-gray-100 hover:border-gray-400 hover:text-gray-800" 
        @click="startAddCard"
      >
        + æ–°å¢å¡ç‰‡
      </button>
      
      <!-- é¡¯ç¤º inline ç·¨è¼¯æ¨¡å¼ -->
      <div 
        v-else
        class="bg-white rounded px-3 py-3 shadow-sm border"
      >
        <textarea
          ref="newCardInput"
          v-model="newCardTitle"
          placeholder="è¼¸å…¥é€™å¼µå¡ç‰‡çš„æ¨™é¡Œ..."
          class="w-full resize-none border-none outline-none text-sm min-h-14"
          @keydown.enter.prevent="saveNewCard"
          @keydown.escape="cancelAddCard"
        />
        <div class="flex gap-2 mt-2">
          <button
            @click="saveNewCard"
            :disabled="!newCardTitle.trim()"
            class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
          >
            æ–°å¢å¡ç‰‡
          </button>
          <button
            @click="cancelAddCard"
            class="px-3 py-1 text-gray-600 text-sm rounded hover:bg-gray-100"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import Card from '@/components/Card.vue'
import ListMenu from '@/components/ListMenu.vue'
import { VueDraggableNext as draggable } from 'vue-draggable-next'
// ğŸ¯ ç´”æ¸²æŸ“çµ„ä»¶ï¼šä¸ç›´æ¥ä½¿ç”¨ composables
import { ref, nextTick } from 'vue'

// ä½¿ç”¨çµ±ä¸€çš„å‹åˆ¥å®šç¾©
import type { ListUI } from '@/types'
type List = ListUI

// ğŸ¯ ç´”æ¸²æŸ“çµ„ä»¶ï¼šæ¥æ”¶çˆ¶çµ„ä»¶å‚³å…¥çš„è³‡æ–™å’Œç‹€æ…‹
const props = defineProps<{
  list: List
  dragging: boolean  // çˆ¶çµ„ä»¶æ§åˆ¶çš„æ‹–æ‹½ç‹€æ…‹
  isMobile?: boolean  // æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆ
}>()

// ğŸ¯ ç´”æ¸²æŸ“çµ„ä»¶ï¼šå®šç¾©äº‹ä»¶ (çˆ¶çµ„ä»¶è™•ç†é‚è¼¯)
const emit = defineEmits<{
  'card-move': [event: any]
  'open-card-modal': [card: any]
  'drag-start': [item: any, type: 'card' | 'list']
  'drag-end': []
  'card-delete': [card: any]
  'card-update-title': [cardId: string, newTitle: string]
  'list-add-card': [listId: string, title: string]
  'list-delete': [listId: string]
  'list-update-title': [listId: string, newTitle: string]
}>()

// ğŸ¯ ç´”æ¸²æŸ“çµ„ä»¶ï¼šç§»é™¤ç›´æ¥ composable ä½¿ç”¨

// ç·¨è¼¯ç‹€æ…‹
const isEditingTitle = ref(false)
const editingTitle = ref('')
const titleInput = ref<HTMLInputElement | null>(null)

// æ–°å¢å¡ç‰‡ç‹€æ…‹
const isAddingCard = ref(false)
const newCardTitle = ref('')
const newCardInput = ref<HTMLTextAreaElement | null>(null)

// ğŸ¯ ç´”æ¸²æŸ“ï¼šè™•ç†æ–°å¢å¡ç‰‡ (å§”æ´¾çµ¦çˆ¶çµ„ä»¶)
const handleAddCard = () => {
  console.log('ğŸ“Œ [PURE-LIST] æ–°å¢å¡ç‰‡äº‹ä»¶ï¼Œå§”æ´¾çµ¦çˆ¶çµ„ä»¶')
  // ä½¿ç”¨ inline æ–°å¢æ¨¡å¼
  startAddCard()
}

// é–‹å§‹ inline æ–°å¢å¡ç‰‡
const startAddCard = async () => {
  isAddingCard.value = true
  newCardTitle.value = ''
  
  // ç­‰å¾… DOM æ›´æ–°å¾Œèšç„¦åˆ°è¼¸å…¥æ¡†
  await nextTick()
  if (newCardInput.value) {
    newCardInput.value.focus()
  }
}

// æ–°å¢ç‹€æ…‹ç®¡ç†ï¼šé˜²æ­¢é‡è¤‡æäº¤
const isSavingCard = ref(false)

// ğŸ¯ ç´”æ¸²æŸ“ï¼šä¿å­˜æ–°å¡ç‰‡ (å§”æ´¾çµ¦çˆ¶çµ„ä»¶)
const saveNewCard = async () => {
  if (isSavingCard.value) return
  
  const titleToSave = newCardTitle.value.trim()
  if (!titleToSave) return
  
  isSavingCard.value = true
  
  try {
    // å§”æ´¾çµ¦çˆ¶çµ„ä»¶è™•ç†æ¥­å‹™é‚è¼¯
    emit('list-add-card', props.list.id, titleToSave)
    
    // UI æ›´æ–°
    isAddingCard.value = false
    newCardTitle.value = ''
    console.log(`ğŸ“Œ [PURE-LIST] æ–°å¢å¡ç‰‡äº‹ä»¶å·²ç™¼é€: ${titleToSave}`)
    
  } catch (error) {
    console.error('âŒ [PURE-LIST] ç™¼é€æ–°å¢å¡ç‰‡äº‹ä»¶å¤±æ•—:', error)
  } finally {
    isSavingCard.value = false
  }
}

// å–æ¶ˆæ–°å¢å¡ç‰‡
const cancelAddCard = () => {
  isAddingCard.value = false
  newCardTitle.value = ''
}

// ğŸ¯ ç´”æ¸²æŸ“ï¼šè™•ç†åˆªé™¤åˆ—è¡¨ (å§”æ´¾çµ¦çˆ¶çµ„ä»¶)
const handleDeleteList = () => {
  console.log('ğŸ—‘ï¸ [PURE-LIST] åˆªé™¤åˆ—è¡¨äº‹ä»¶ï¼Œå§”æ´¾çµ¦çˆ¶çµ„ä»¶:', props.list.title)
  emit('list-delete', props.list.id)
}

// é–‹å§‹ç·¨è¼¯æ¨™é¡Œ
const startEditTitle = async () => {
  isEditingTitle.value = true
  editingTitle.value = props.list.title
  
  // ç­‰å¾… DOM æ›´æ–°å¾Œèšç„¦ä¸¦å…¨é¸æ–‡å­—
  await nextTick()
  if (titleInput.value) {
    titleInput.value.focus()
    titleInput.value.select()
  }
}

// ğŸ¯ ç´”æ¸²æŸ“ï¼šå„²å­˜æ¨™é¡Œè®Šæ›´ (å§”æ´¾çµ¦çˆ¶çµ„ä»¶)
const saveTitle = async () => {
  const newTitle = editingTitle.value.trim()
  if (newTitle && newTitle !== props.list.title) {
    console.log('âœï¸ [PURE-LIST] æ›´æ–°åˆ—è¡¨æ¨™é¡Œäº‹ä»¶ï¼Œå§”æ´¾çµ¦çˆ¶çµ„ä»¶:', { old: props.list.title, new: newTitle })
    emit('list-update-title', props.list.id, newTitle)
  }
  isEditingTitle.value = false
}

// å–æ¶ˆç·¨è¼¯
const cancelEdit = () => {
  editingTitle.value = props.list.title
  isEditingTitle.value = false
}
</script>