/**
 * ğŸ“¢ Observer Pattern = å­¸æ ¡å»£æ’­ç³»çµ±
 * 
 * ğŸ¤” æƒ³åƒå­¸æ ¡è£¡ç™¼ç”Ÿäº†é‡è¦çš„äº‹ï¼š
 * 
 * âŒ æ²’æœ‰å»£æ’­çš„ä¸–ç•Œï¼š
 * - è€å¸«è¦ä¸€é–“é–“æ•™å®¤è·‘å»é€šçŸ¥ã€Œä¸‹èª²äº†ã€
 * - å¦‚æœæœ‰æ–°æ•™å®¤ï¼Œè€å¸«è¦è¨˜å¾—å»é€šçŸ¥
 * - å¦‚æœè€å¸«å¿˜è¨˜é€šçŸ¥æŸé–“æ•™å®¤ï¼Œå­¸ç”Ÿå°±ä¸çŸ¥é“ä¸‹èª²äº†
 * 
 * âœ… æœ‰å»£æ’­ç³»çµ±çš„ä¸–ç•Œï¼š
 * - è€å¸«å°è‘—å»£æ’­èªªã€Œä¸‹èª²äº†ã€
 * - æ‰€æœ‰æ•™å®¤çš„å–‡å­éƒ½æœƒæ’­æ”¾é€™å€‹è¨Šæ¯
 * - æ–°æ•™å®¤ï¼Ÿè£å€‹å–‡å­å°±è‡ªå‹•æ”¶åˆ°é€šçŸ¥äº†
 * - æŸé–“æ•™å®¤ä¸æƒ³è½ï¼ŸæŠŠå–‡å­é—œæ‰å°±å¥½
 * 
 * ğŸ¯ é€™å€‹æª”æ¡ˆå°±æ˜¯ã€Œç¨‹å¼ç¢¼çš„å»£æ’­ç³»çµ±ã€ï¼š
 * - ç•¶å¡ç‰‡è¢«æ–°å¢æ™‚ï¼Œå»£æ’­ã€Œæœ‰æ–°å¡ç‰‡äº†ã€
 * - æƒ³è¦çŸ¥é“çš„çµ„ä»¶å°±ã€Œæ‰“é–‹å–‡å­ã€æ”¶è½
 * - ä¸é—œå¿ƒçš„çµ„ä»¶å°±ä¸ç”¨ç†æœƒ
 * 
 * ğŸ“ ä½¿ç”¨æ–¹å¼ï¼š
 * // å»£æ’­è¨Šæ¯ï¼ˆåƒè€å¸«å°å»£æ’­è¬›è©±ï¼‰
 * eventBus.emit('card:created', { cardId: '123', title: 'æ–°å¡ç‰‡' })
 * 
 * // æ”¶è½è¨Šæ¯ï¼ˆåƒæ•™å®¤å®‰è£å–‡å­ï¼‰
 * eventBus.on('card:created', (data) => {
 *   console.log('æ”¶åˆ°æ–°å¡ç‰‡:', data.title)
 * })
 * 
 * ğŸ’¡ ç°¡å–®èªªï¼šä¸è¦è®“çµ„ä»¶ç›´æ¥æ‰¾å°æ–¹ï¼Œç”¨å»£æ’­ç³»çµ±å‚³æ¶ˆæ¯æ¯”è¼ƒå¥½
 */

/**
 * ğŸ“‹ äº‹ä»¶é¡å‹å®šç¾© - å°±åƒå»£æ’­é›»å°çš„ç¯€ç›®è¡¨
 * 
 * ğŸ¤” ç‚ºä»€éº¼è¦å®šç¾©é€™äº›ï¼Ÿ
 * - ç¢ºä¿æ¯å€‹äº‹ä»¶çš„è³‡æ–™æ ¼å¼éƒ½æ˜¯å°çš„
 * - è®“ TypeScript å¹«æˆ‘å€‘æª¢æŸ¥æ‹¼å­—éŒ¯èª¤
 * - è®“å…¶ä»–é–‹ç™¼è€…çŸ¥é“æœ‰å“ªäº›äº‹ä»¶å¯ä»¥ä½¿ç”¨
 */
export interface AppEvents {
  // å¡ç‰‡ç›¸é—œäº‹ä»¶
  'card:created': { cardId: string, listId: string, title: string }    // æ–°å¢å¡ç‰‡æ™‚å»£æ’­
  'card:deleted': { cardId: string, listId: string }                   // åˆªé™¤å¡ç‰‡æ™‚å»£æ’­
  'card:moved': { cardId: string, fromListId: string, toListId: string } // ç§»å‹•å¡ç‰‡æ™‚å»£æ’­
  
  // åˆ—è¡¨ç›¸é—œäº‹ä»¶
  'list:created': { listId: string, title: string }                    // æ–°å¢åˆ—è¡¨æ™‚å»£æ’­
  'list:deleted': { listId: string }                                   // åˆªé™¤åˆ—è¡¨æ™‚å»£æ’­
  
  // ä½¿ç”¨è€…ç›¸é—œäº‹ä»¶
  'user:login': { userId: string, email: string }                      // ä½¿ç”¨è€…ç™»å…¥æ™‚å»£æ’­
  'user:logout': { userId: string }                                    // ä½¿ç”¨è€…ç™»å‡ºæ™‚å»£æ’­
  
  // ç³»çµ±ç›¸é—œäº‹ä»¶
  'notification:show': { type: 'success' | 'error' | 'info', message: string } // é¡¯ç¤ºé€šçŸ¥æ™‚å»£æ’­
  'notification:error': { title: string, message: string, duration?: number } // éŒ¯èª¤é€šçŸ¥äº‹ä»¶
  'error:occurred': { error: Error, context: string }                  // ç™¼ç”ŸéŒ¯èª¤æ™‚å»£æ’­
}

/**
 * ğŸ“ äº‹ä»¶å›èª¿å‡½æ•¸çš„å‹åˆ¥å®šç¾©
 * 
 * ğŸ¤” é€™æ˜¯ä»€éº¼ï¼Ÿ
 * - å°±åƒé›»è©±çš„ã€Œæ¥è½å‡½æ•¸ã€
 * - ç•¶äº‹ä»¶ç™¼ç”Ÿæ™‚ï¼Œé€™å€‹å‡½æ•¸æœƒè¢«å‘¼å«
 * - T æ˜¯å‚³å…¥è³‡æ–™çš„å‹åˆ¥ï¼ˆæ¯”å¦‚å¡ç‰‡è³‡æ–™ã€éŒ¯èª¤è³‡æ–™ç­‰ï¼‰
 */
type EventCallback<T = any> = (data: T) => void

export class EventBus {
  /**
   * ğŸ  éœæ…‹å¯¦ä¾‹ - æ•´å€‹æ‡‰ç”¨å…±ç”¨çš„å”¯ä¸€ EventBus
   * 
   * ğŸ¤” ç‚ºä»€éº¼è¦ç”¨ staticï¼Ÿ
   * - ç¢ºä¿æ•´å€‹æ‡‰ç”¨åªæœ‰ä¸€å€‹å»£æ’­ç³»çµ±
   * - å°±åƒå­¸æ ¡åªæœ‰ä¸€å€‹å»£æ’­å®¤ï¼Œä¸æœƒæœ‰å…©å€‹å»£æ’­å®¤åŒæ™‚å»£æ’­
   */
  private static instance: EventBus
  
  /**
   * ğŸ“» ç›£è½å™¨å®¹å™¨ - å­˜æ”¾æ‰€æœ‰ã€Œå–‡å­ã€çš„åœ°æ–¹
   * 
   * ğŸ¤” Map çµæ§‹èªªæ˜ï¼š
   * - Key: äº‹ä»¶åç¨± (ä¾‹å¦‚: 'card:created')
   * - Value: ç›£è½é€™å€‹äº‹ä»¶çš„æ‰€æœ‰å‡½æ•¸é™£åˆ—
   * 
   * ğŸ“ ä¾‹å­ï¼š
   * Map {
   *   'card:created' => [å‡½æ•¸A, å‡½æ•¸B, å‡½æ•¸C],
   *   'list:deleted' => [å‡½æ•¸D, å‡½æ•¸E]
   * }
   */
  private listeners: Map<string, EventCallback[]> = new Map()

  /**
   * ğŸ—ï¸ å–®ä¾‹æ¨¡å¼ - å–å¾—å”¯ä¸€çš„ EventBus å¯¦ä¾‹
   * 
   * ğŸ¤” ä»€éº¼æ˜¯å–®ä¾‹æ¨¡å¼ï¼Ÿ
   * - å°±åƒæ”¿åºœåªèƒ½æœ‰ä¸€å€‹ç¸½çµ±
   * - ç¢ºä¿æ•´å€‹æ‡‰ç”¨åªæœ‰ä¸€å€‹äº‹ä»¶å»£æ’­ç³»çµ±
   * - ç„¡è«–åœ¨å“ªè£¡å‘¼å«ï¼Œéƒ½æœƒå¾—åˆ°åŒä¸€å€‹ EventBus
   * 
   * ğŸ“ ä½¿ç”¨æ–¹å¼ï¼š
   * const eventBus1 = EventBus.getInstance()
   * const eventBus2 = EventBus.getInstance()
   * // eventBus1 === eventBus2 (æ˜¯åŒä¸€å€‹ç‰©ä»¶)
   */
  static getInstance(): EventBus {
    // å¦‚æœé‚„æ²’æœ‰å¯¦ä¾‹ï¼Œå°±å»ºç«‹ä¸€å€‹
    if (!EventBus.instance) {
      EventBus.instance = new EventBus()
    }
    // å›å‚³å”¯ä¸€çš„å¯¦ä¾‹
    return EventBus.instance
  }

  /**
   * ğŸ”Š è¨‚é–±äº‹ä»¶ - åœ¨æ•™å®¤è£¡å®‰è£å–‡å­
   * 
   * ğŸ¤” é€™å€‹å‡½æ•¸åšä»€éº¼ï¼Ÿ
   * - å‘Šè¨´ç³»çµ±ï¼šã€Œç•¶ XXX äº‹ä»¶ç™¼ç”Ÿæ™‚ï¼Œè«‹å‘¼å«æˆ‘çš„å‡½æ•¸ã€
   * - å°±åƒåœ¨æ•™å®¤å®‰è£å–‡å­ï¼Œç•¶å»£æ’­æ™‚å°±æœƒæ’­æ”¾
   * 
   * ğŸ“ ä½¿ç”¨ä¾‹å­ï¼š
   * eventBus.on('card:created', (data) => {
   *   console.log('æœ‰æ–°å¡ç‰‡:', data.title)
   * })
   * 
   * ğŸ”§ åƒæ•¸èªªæ˜ï¼š
   * @param event - è¦ç›£è½çš„äº‹ä»¶åç¨± (ä¾‹å¦‚: 'card:created')
   * @param callback - äº‹ä»¶ç™¼ç”Ÿæ™‚è¦åŸ·è¡Œçš„å‡½æ•¸
   */
  on<K extends keyof AppEvents>(event: K, callback: EventCallback<AppEvents[K]>): void {
    // æª¢æŸ¥é€™å€‹äº‹ä»¶æ˜¯å¦å·²ç¶“æœ‰ç›£è½å™¨é™£åˆ—äº†
    if (!this.listeners.has(event)) {
      // å¦‚æœæ²’æœ‰ï¼Œå°±å»ºç«‹ä¸€å€‹ç©ºé™£åˆ—
      this.listeners.set(event, [])
    }
    // æŠŠæ–°çš„ç›£è½å‡½æ•¸åŠ åˆ°é™£åˆ—è£¡
    this.listeners.get(event)!.push(callback)
  }

  /**
   * ğŸ”‡ å–æ¶ˆè¨‚é–± - æŠŠæ•™å®¤çš„å–‡å­æ‹†æ‰
   * 
   * ğŸ¤” é€™å€‹å‡½æ•¸åšä»€éº¼ï¼Ÿ
   * - å‘Šè¨´ç³»çµ±ï¼šã€Œæˆ‘ä¸æƒ³å†è½é€™å€‹äº‹ä»¶äº†ã€
   * - å°±åƒæŠŠæ•™å®¤çš„å–‡å­æ‹†æ‰ï¼Œä¹‹å¾Œå»£æ’­å°±è½ä¸åˆ°äº†
   * 
   * ğŸ“ ä½¿ç”¨ä¾‹å­ï¼š
   * const myCallback = (data) => console.log(data)
   * eventBus.on('card:created', myCallback)     // é–‹å§‹ç›£è½
   * eventBus.off('card:created', myCallback)    // åœæ­¢ç›£è½
   * 
   * ğŸ”§ åƒæ•¸èªªæ˜ï¼š
   * @param event - è¦åœæ­¢ç›£è½çš„äº‹ä»¶åç¨±
   * @param callback - è¦ç§»é™¤çš„ç›£è½å‡½æ•¸ï¼ˆå¿…é ˆæ˜¯åŒä¸€å€‹å‡½æ•¸ç‰©ä»¶ï¼‰
   */
  off<K extends keyof AppEvents>(event: K, callback: EventCallback<AppEvents[K]>): void {
    // å–å¾—é€™å€‹äº‹ä»¶çš„æ‰€æœ‰ç›£è½å™¨
    const eventListeners = this.listeners.get(event)
    if (eventListeners) {
      // æ‰¾åˆ°è¦ç§»é™¤çš„å‡½æ•¸åœ¨é™£åˆ—ä¸­çš„ä½ç½®
      const index = eventListeners.indexOf(callback)
      if (index > -1) {
        // å¾é™£åˆ—ä¸­ç§»é™¤é€™å€‹å‡½æ•¸
        eventListeners.splice(index, 1)
        // å¦‚æœç§»é™¤å¾Œé™£åˆ—ç‚ºç©ºï¼Œå°±å¾ Map ä¸­åˆªé™¤é€™å€‹äº‹ä»¶ï¼Œé¿å…è¨˜æ†¶é«”æ´©æ¼
        if (eventListeners.length === 0) {
          this.listeners.delete(event)
        }
      }
    }
  }

  /**
   * ğŸ“¢ ç™¼å¸ƒäº‹ä»¶ - æ ¡é•·å°è‘—å»£æ’­ç³»çµ±èªªè©±
   * 
   * ğŸ¤” é€™å€‹å‡½æ•¸åšä»€éº¼ï¼Ÿ
   * - å‘æ‰€æœ‰ç›£è½é€™å€‹äº‹ä»¶çš„å‡½æ•¸ç™¼é€è¨Šæ¯
   * - å°±åƒæ ¡é•·èªªã€Œä¸‹èª²äº†ã€ï¼Œæ‰€æœ‰æ•™å®¤çš„å–‡å­éƒ½æœƒæ’­æ”¾
   * 
   * ğŸ“ ä½¿ç”¨ä¾‹å­ï¼š
   * eventBus.emit('card:created', {
   *   cardId: '123',
   *   listId: 'abc',
   *   title: 'æˆ‘çš„æ–°å¡ç‰‡'
   * })
   * 
   * ğŸ”§ åƒæ•¸èªªæ˜ï¼š
   * @param event - è¦ç™¼å¸ƒçš„äº‹ä»¶åç¨±
   * @param data - è¦å‚³é€çš„è³‡æ–™
   */
  emit<K extends keyof AppEvents>(event: K, data: AppEvents[K]): void {
    // å–å¾—æ‰€æœ‰ç›£è½é€™å€‹äº‹ä»¶çš„å‡½æ•¸
    const eventListeners = this.listeners.get(event)
    if (eventListeners) {
      // ğŸ›¡ï¸ å®‰å…¨æªæ–½ï¼šè¤‡è£½é™£åˆ—é¿å…åœ¨åŸ·è¡Œéç¨‹ä¸­è¢«ä¿®æ”¹
      // ç‚ºä»€éº¼è¦è¤‡è£½ï¼Ÿå› ç‚ºåœ¨åŸ·è¡Œå›èª¿å‡½æ•¸æ™‚ï¼Œå¯èƒ½æœƒæœ‰å…¶ä»–ç¨‹å¼ç¢¼ä¿®æ”¹ç›£è½å™¨é™£åˆ—
      [...eventListeners].forEach(callback => {
        try {
          // å‘¼å«æ¯å€‹ç›£è½å‡½æ•¸ï¼ŒæŠŠè³‡æ–™å‚³çµ¦å®ƒ
          callback(data)
        } catch (error) {
          // ğŸš¨ éŒ¯èª¤è™•ç†ï¼šå¦‚æœæŸå€‹ç›£è½å‡½æ•¸å‡ºéŒ¯ï¼Œä¸è¦å½±éŸ¿å…¶ä»–å‡½æ•¸
          console.error(`äº‹ä»¶è™•ç†å™¨éŒ¯èª¤ [${event}]:`, error)
        }
      })
    }
  }

  /**
   * ğŸ¯ ä¸€æ¬¡æ€§è¨‚é–± - åªè½ä¸€æ¬¡å°±è‡ªå‹•æ‹†æ‰å–‡å­
   * 
   * ğŸ¤” é€™å€‹å‡½æ•¸åšä»€éº¼ï¼Ÿ
   * - ç›£è½äº‹ä»¶ï¼Œä½†åªè§¸ç™¼ä¸€æ¬¡ï¼Œä¹‹å¾Œå°±è‡ªå‹•åœæ­¢ç›£è½
   * - å°±åƒè‡¨æ™‚è£å€‹å–‡å­ï¼Œè½åˆ°å»£æ’­å¾Œå°±è‡ªå‹•æ‹†æ‰
   * 
   * ğŸ“ ä½¿ç”¨å ´æ™¯ï¼š
   * - ç­‰å¾…ä½¿ç”¨è€…ç¬¬ä¸€æ¬¡ç™»å…¥
   * - ç­‰å¾…æŸå€‹ä¸€æ¬¡æ€§çš„åˆå§‹åŒ–å®Œæˆ
   * - ç­‰å¾…æŸå€‹åªæœƒç™¼ç”Ÿä¸€æ¬¡çš„äº‹ä»¶
   * 
   * ğŸ’¡ ä½¿ç”¨ä¾‹å­ï¼š
   * eventBus.once('user:login', (data) => {
   *   console.log('æ­¡è¿é¦–æ¬¡ç™»å…¥!', data.email)
   *   // é€™å€‹å‡½æ•¸åªæœƒåŸ·è¡Œä¸€æ¬¡ï¼Œä¹‹å¾Œå°±ä¸æœƒå†åŸ·è¡Œäº†
   * })
   * 
   * ğŸ”§ åƒæ•¸èªªæ˜ï¼š
   * @param event - è¦ç›£è½çš„äº‹ä»¶åç¨±
   * @param callback - äº‹ä»¶ç™¼ç”Ÿæ™‚è¦åŸ·è¡Œçš„å‡½æ•¸ï¼ˆåªåŸ·è¡Œä¸€æ¬¡ï¼‰
   */
  once<K extends keyof AppEvents>(event: K, callback: EventCallback<AppEvents[K]>): void {
    // å»ºç«‹ä¸€å€‹åŒ…è£å‡½æ•¸
    const onceCallback = (data: AppEvents[K]) => {
      try {
        // å…ˆåŸ·è¡Œä½¿ç”¨è€…æä¾›çš„å›èª¿å‡½æ•¸
        callback(data)
      } finally {
        // åŸ·è¡Œå®Œå¾Œç«‹åˆ»ç§»é™¤é€™å€‹ç›£è½å™¨ï¼Œç¢ºä¿åªåŸ·è¡Œä¸€æ¬¡
        this.off(event, onceCallback)
      }
    }
    // è¨»å†Šé€™å€‹åŒ…è£å‡½æ•¸ä½œç‚ºç›£è½å™¨
    this.on(event, onceCallback)
  }

  /**
   * ğŸ§¹ æ¸…é™¤æ‰€æœ‰ç›£è½å™¨ - æŠŠå­¸æ ¡æ‰€æœ‰å–‡å­éƒ½æ‹†æ‰
   * 
   * ğŸ¤” ä»€éº¼æ™‚å€™æœƒç”¨åˆ°ï¼Ÿ
   * - æ‡‰ç”¨ç¨‹å¼é—œé–‰æ™‚
   * - é‡ç½®æ•´å€‹äº‹ä»¶ç³»çµ±æ™‚
   * - æ¸¬è©¦å®Œæˆå¾Œæ¸…ç†ç’°å¢ƒæ™‚
   * 
   * âš ï¸ æ³¨æ„ï¼šé€™æœƒç§»é™¤æ‰€æœ‰äº‹ä»¶çš„æ‰€æœ‰ç›£è½å™¨ï¼
   * 
   * ğŸ“ ä½¿ç”¨ä¾‹å­ï¼š
   * // åœ¨æ‡‰ç”¨é—œé–‰æ™‚æ¸…ç†
   * window.addEventListener('beforeunload', () => {
   *   eventBus.removeAllListeners()
   * })
   */
  removeAllListeners(): void {
    // æ¸…ç©ºæ•´å€‹ Mapï¼Œç§»é™¤æ‰€æœ‰äº‹ä»¶çš„æ‰€æœ‰ç›£è½å™¨
    this.listeners.clear()
  }

  /**
   * ğŸ” é™¤éŒ¯åŠŸèƒ½ - æŸ¥çœ‹ç›®å‰æœ‰å¤šå°‘å–‡å­åœ¨é‹ä½œ
   * 
   * ğŸ¤” é€™å€‹å‡½æ•¸åšä»€éº¼ï¼Ÿ
   * - å¹«åŠ©é–‹ç™¼è€…äº†è§£ç›®å‰æœ‰å¤šå°‘ç›£è½å™¨åœ¨é‹ä½œ
   * - ç”¨ä¾†é™¤éŒ¯æˆ–ç›£æ§ç³»çµ±ç‹€æ…‹
   * 
   * ğŸ“ ä½¿ç”¨ä¾‹å­ï¼š
   * // æŸ¥çœ‹ç‰¹å®šäº‹ä»¶çš„ç›£è½å™¨æ•¸é‡
   * const count = eventBus.getListenerCount('card:created')  // å›å‚³æ•¸å­—
   * 
   * // æŸ¥çœ‹æ‰€æœ‰äº‹ä»¶çš„ç›£è½å™¨æ•¸é‡
   * const allCounts = eventBus.getListenerCount()  // å›å‚³ç‰©ä»¶
   * // çµæœåƒé€™æ¨£ï¼š{ 'card:created': 3, 'list:deleted': 1 }
   * 
   * ğŸ”§ åƒæ•¸èªªæ˜ï¼š
   * @param event - å¯é¸ï¼ŒæŒ‡å®šè¦æŸ¥çœ‹çš„äº‹ä»¶åç¨±
   * @returns å¦‚æœæœ‰æŒ‡å®šäº‹ä»¶ï¼Œå›å‚³æ•¸å­—ï¼›å¦‚æœæ²’æŒ‡å®šï¼Œå›å‚³æ‰€æœ‰äº‹ä»¶çš„çµ±è¨ˆç‰©ä»¶
   */
  getListenerCount(event?: keyof AppEvents): number | Record<string, number> {
    if (event) {
      // å¦‚æœæŒ‡å®šäº†äº‹ä»¶ï¼Œå›å‚³è©²äº‹ä»¶çš„ç›£è½å™¨æ•¸é‡
      return this.listeners.get(event)?.length || 0
    }
    
    // å¦‚æœæ²’æŒ‡å®šäº‹ä»¶ï¼Œå›å‚³æ‰€æœ‰äº‹ä»¶çš„çµ±è¨ˆ
    const counts: Record<string, number> = {}
    this.listeners.forEach((listeners, eventName) => {
      counts[eventName] = listeners.length
    })
    return counts
  }
}

/**
 * ğŸš€ åŒ¯å‡ºé è¨­çš„ EventBus å¯¦ä¾‹
 * 
 * ğŸ¤” ç‚ºä»€éº¼è¦é€™æ¨£åšï¼Ÿ
 * - è®“å…¶ä»–æª”æ¡ˆå¯ä»¥ç›´æ¥ import ä½¿ç”¨ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å¯« EventBus.getInstance()
 * - ç¢ºä¿æ•´å€‹æ‡‰ç”¨ä½¿ç”¨çš„éƒ½æ˜¯åŒä¸€å€‹ EventBus å¯¦ä¾‹
 * 
 * ğŸ“ ä½¿ç”¨æ–¹å¼ï¼š
 * import { eventBus } from '@/events/EventBus'
 * 
 * eventBus.on('card:created', callback)
 * eventBus.emit('card:created', data)
 */
export const eventBus = EventBus.getInstance()